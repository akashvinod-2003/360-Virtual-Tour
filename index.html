<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith University - AI Powered Tour</title>
    
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Markdown Parser for AI Responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* 1. Full Screen Unity Container */
        #unity-container {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            z-index: 0; 
        }
        
        #unity-canvas {
            width: 100%;
            height: 100%;
            background: #232323;
        }

        /* Demo Mode Background (Shown when build is missing) */
        .demo-mode-bg {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1541339907198-e08756dedf3f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
        }

        /* 2. Loading Screen */
        #unity-loading-bar {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 50;
            transition: opacity 0.5s ease-out;
        }

        .progress-track {
            width: 200px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: #4f46e5;
            transition: width 0.1s linear;
        }

        /* 3. AI Chat Widget Styles */
        .glass-panel {
            background: rgba(15, 23, 42, 0.90);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .chat-anim { animation: slideIn 0.3s ease-out forwards; }

        /* Scrollbar for chat */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        
        .ai-content p { margin-bottom: 0.5rem; }
        .ai-content strong { color: #818cf8; }
    </style>
</head>
<body class="text-white h-screen w-screen relative">

    <!-- UNITY CONTAINER -->
    <div id="unity-container">
        <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
    </div>

    <!-- LOADING SCREEN -->
    <div id="unity-loading-bar">
        <div class="mb-4">
            <i class="fas fa-university text-5xl text-indigo-500 animate-bounce"></i>
        </div>
        <div class="text-sm font-semibold tracking-widest uppercase text-gray-300 mb-2">Loading Virtual Campus...</div>
        <div class="progress-track">
            <div id="unity-progress-bar-full" class="progress-fill"></div>
        </div>
    </div>

    <!-- AI TOUR GUIDE WIDGET -->
    <div class="absolute bottom-6 right-6 z-30 pointer-events-auto flex flex-col items-end gap-2">
        <div id="ai-chat-window" class="hidden glass-panel w-80 h-96 rounded-2xl flex flex-col overflow-hidden shadow-2xl chat-anim origin-bottom-right mb-2">
            <div class="bg-indigo-600 p-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-white/20 p-1.5 rounded-full">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <span class="font-bold text-sm">Zenith AI Guide</span>
                </div>
                <button onclick="toggleChat()" class="text-white/70 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="chat-messages" class="flex-1 p-3 overflow-y-auto space-y-3 text-sm">
                <div class="bg-white/10 p-2 rounded-lg rounded-tl-none self-start max-w-[90%]">
                    <p>Welcome! I'm here to help. Ask me about any room you visit! ðŸ‘‹</p>
                </div>
            </div>

            <div class="p-3 bg-black/20 border-t border-white/10">
                <form onsubmit="handleChatSubmit(event)" class="relative">
                    <input type="text" id="chat-input" placeholder="Ask a question..." 
                        class="w-full bg-black/30 border border-white/20 rounded-full py-2 pl-3 pr-10 text-xs focus:outline-none focus:border-indigo-500 text-white placeholder-gray-400">
                    <button type="submit" class="absolute right-1 top-1 w-7 h-7 bg-indigo-600 rounded-full flex items-center justify-center hover:bg-indigo-500 transition-colors">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </form>
            </div>
        </div>

        <button onclick="toggleChat()" class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full shadow-lg shadow-indigo-500/40 hover:scale-105 transition-transform flex items-center justify-center group border border-white/20">
            <i class="fas fa-comment-dots text-2xl animate-pulse group-hover:animate-none"></i>
        </button>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 0. GEMINI API SETUP ---
        const apiKey = ""; 

        async function callGemini(prompt) {
            if (!apiKey) return "Error: API Key is missing.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Sorry, I'm having trouble connecting right now.";
            }
        }

        // --- 1. AI CHAT LOGIC ---
        function toggleChat() {
            const win = document.getElementById('ai-chat-window');
            win.classList.toggle('hidden');
            if (!win.classList.contains('hidden')) document.getElementById('chat-input').focus();
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msgArea = document.getElementById('chat-messages');
            const userText = input.value.trim();
            
            if (!userText) return;

            const userDiv = document.createElement('div');
            userDiv.className = 'bg-indigo-600 text-white p-2 rounded-lg rounded-tr-none self-end max-w-[90%]';
            userDiv.textContent = userText;
            msgArea.appendChild(userDiv);
            
            input.value = '';
            msgArea.scrollTop = msgArea.scrollHeight;

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'bg-white/10 p-2 rounded-lg rounded-tl-none self-start text-gray-400 text-xs italic';
            loadingDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> Thinking...';
            loadingDiv.id = 'chat-loading';
            msgArea.appendChild(loadingDiv);

            const prompt = `You are a student tour guide at Zenith University. 
            The user is navigating a 3D tour. Answer their question enthusiastically.
            User: ${userText}
            Guide:`;
            
            const aiResponse = await callGemini(prompt);

            document.getElementById('chat-loading').remove();
            
            const aiDiv = document.createElement('div');
            aiDiv.className = 'bg-white/10 p-2 rounded-lg rounded-tl-none self-start max-w-[90%] ai-content';
            aiDiv.innerHTML = marked.parse(aiResponse);
            msgArea.appendChild(aiDiv);
            msgArea.scrollTop = msgArea.scrollHeight;
        }

        // --- 2. UNITY LOADER LOGIC (FIXED FOR SCREENSHOT) ---
        
        // Configuration: Matches "WebGL Builds" with space
        const buildFolder = "Build";
        const buildName = "WebGL Builds"; 
        
        // We use encodeURIComponent to safely handle the space in "WebGL Builds"
        const safeBuildName = encodeURIComponent(buildName);
        
        // Construct paths with safe encoding
        const loaderUrl = `${buildFolder}/${safeBuildName}.loader.js`;
        
        const config = {
            dataUrl: `${buildFolder}/${safeBuildName}.data.br`,
            frameworkUrl: `${buildFolder}/${safeBuildName}.framework.js.br`,
            codeUrl: `${buildFolder}/${safeBuildName}.wasm.br`,
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "360 Tour",
            productVersion: "0.1.0",
        };

        const canvas = document.querySelector("#unity-canvas");
        const loadingBar = document.querySelector("#unity-loading-bar");
        const progressBarFull = document.querySelector("#unity-progress-bar-full");

        // Helper to load script
        function loadUnityScript(url, config) {
            return new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.src = url;
                script.onload = () => {
                    createUnityInstance(canvas, config, (progress) => {
                        progressBarFull.style.width = (100 * progress) + "%";
                    }).then((instance) => {
                        resolve(instance);
                    }).catch((message) => {
                        reject("Instance creation failed: " + message);
                    });
                };
                script.onerror = () => {
                    reject("Script failed to load: " + url);
                };
                document.body.appendChild(script);
            });
        }

        // Main Load Sequence
        async function initUnity() {
            try {
                console.log("Loading Unity from: " + loaderUrl);
                await loadUnityScript(loaderUrl, config);
                loadingBar.style.display = "none";
                console.log("Unity Loaded Successfully");
            } catch (e) {
                console.error("Load failed:", e);
                showErrorUI(loaderUrl);
            }
        }

        function showErrorUI(urlAttempted) {
             loadingBar.innerHTML = `
                <div class="bg-slate-900/95 p-6 rounded-xl border border-red-500/50 text-center max-w-md shadow-2xl backdrop-blur-md">
                    <i class="fas fa-cube text-4xl text-gray-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-white mb-2">Build Files Not Found</h3>
                    <p class="text-gray-300 text-sm mb-4">
                        We tried to load <code class="text-red-300 bg-black/30 px-1 rounded">${decodeURIComponent(urlAttempted)}</code> but failed.
                    </p>
                    <div class="text-left bg-black/30 p-3 rounded text-xs text-gray-400 mb-4 font-mono">
                         Troubleshooting:<br>
                         1. Ensure this file (index.html) is in "WEBGL BUILDS"<br>
                         2. Ensure "Build" folder is next to it.<br>
                         3. Are you running this via a Server? (required for .br files)
                    </div>
                    <button onclick="enterDemoMode()" class="bg-indigo-600 hover:bg-indigo-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 mx-auto">
                        <span>Enter Demo Mode</span>
                    </button>
                </div>
             `;
        }

        function enterDemoMode() {
            loadingBar.style.display = 'none';
            canvas.classList.add('demo-mode-bg');
            console.log("Entered Demo Mode (Unity Bypassed)");
        }

        // Start
        initUnity();

    </script>
</body>
</html>